<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suivi des actions - Paris</title>
    
    <link rel="icon" href="logo.jpg" type="image/jpeg">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
    
    <style>
        body, html { 
            margin: 0; padding: 0; 
            height: 100%; width: 100%; 
            position: fixed; 
            overflow: hidden; 
            overscroll-behavior: none; 
            font-family: sans-serif; 
            background-color: #2c3e50; 
        }
        
        #header { 
            position: absolute; top: 0; left: 0; width: 100%; 
            height: 70px; 
            background: #2c3e50; color: white; 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 20px; z-index: 2000; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .stats-container { width: 300px; text-align: right; margin-left: 15px; }
        .progress { height: 10px; background-color: #4a6278; }
        
        #map { 
            position: absolute; top: 70px; bottom: 0; left: 0; right: 0;
            background: #e5e5e5; 
            z-index: 1;
        }
        
        #search-container { 
            position: absolute; top: 85px; left: 50%; transform: translateX(-50%); 
            width: 300px; z-index: 1500; 
        }
        #search-input { width: 100%; padding: 10px; border-radius: 20px; border: 2px solid rgba(0,0,0,0.2); box-shadow: 0 4px 6px rgba(0,0,0,0.1); outline: none; font-size: 16px; background: white; }
        #search-results { background: white; margin-top: 5px; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.2); display: none; max-height: 300px; overflow-y: auto; }
        .search-result-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 13px; }
        .search-result-item:hover { background-color: #f8f9fa; }

        .legend-container { position: absolute; bottom: 30px; right: 10px; z-index: 1000; background: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.2); overflow: hidden; width: 200px; transition: all 0.3s ease; }
        .legend-header { padding: 10px 15px; background: #f8f9fa; border-bottom: 1px solid #eee; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; align-items: center; user-select: none; }
        .legend-content { padding: 15px; }
        .legend-container.collapsed .legend-content { display: none; }
        .legend-container.collapsed { width: auto; }
        .legend-item { margin-bottom: 8px; display: flex; align-items: center; }
        .legend-color { width: 20px; height: 20px; border-radius: 4px; margin-right: 10px; display: inline-block; }
        
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; transition: opacity 0.5s ease; text-align: center; padding: 20px; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        
        .leaflet-left .leaflet-control { margin-bottom: 10px; }
        .leaflet-control-geoloc { background-color: white; width: 34px; height: 34px; border-radius: 4px; border: 2px solid rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .geoloc-icon { width: 20px; height: 20px; fill: #333; }
        
        .custom-filter select { pointer-events: auto; background: white; border: 2px solid rgba(0,0,0,0.4); border-radius: 4px; padding: 5px; font-weight: bold; font-size: 13px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.4); }
        .leaflet-control-layers { border: 2px solid rgba(0,0,0,0.4) !important; border-radius: 4px !important; box-shadow: 0 2px 5px rgba(0,0,0,0.4) !important; margin-left: 10px !important; }
        
        path.leaflet-interactive:focus { outline: none; }
        .leaflet-interactive { -webkit-tap-highlight-color: transparent; }

        .street-tooltip { background: rgba(255, 255, 255, 0.95); border: 1px solid #333; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.4); font-weight: bold; font-size: 12px; padding: 2px 6px; color: #333; }
        
        .note-tooltip { background: #6f42c1; color: white; border: none; border-radius: 4px; padding: 5px 10px; font-weight: bold; }
        .note-popup .leaflet-popup-content-wrapper { background: #f8f9fa; border-radius: 8px; }
        .btn-delete-note { background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; width: 100%; margin-top: 5px; }

        .user-location-marker { background-color: #4285F4; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.3); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(66, 133, 244, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(66, 133, 244, 0); } 100% { box-shadow: 0 0 0 0 rgba(66, 133, 244, 0); } }

        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #2c3e50; z-index: 100000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }

        @media (max-width: 768px) {
            #header { height: 60px; padding: 0 10px; }
            #header img { height: 35px; }
            #header h1 { font-size: 0.8rem; line-height: 1.1; white-space: normal; }
            .stats-container { width: 110px; margin-left: 8px; }
            #stats-text { font-size: 0.7rem; }
            #map { top: 60px; }
            #search-container { width: 90%; top: 70px; }
            .leaflet-control-zoom { display: none; }
            .legend-container { width: 160px; bottom: 20px; right: 5px; }
            .legend-content { padding: 10px; font-size: 12px; }
            .leaflet-top { top: 130px; transition: top 0.3s; } 
            .leaflet-control-layers { margin-top: 0 !important; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <img src="logo.jpg" alt="Logo" style="height: 80px; width: auto; margin-bottom: 20px; border-radius: 50%; object-fit: contain; background: white; padding: 5px;">
        <h2 class="h4 mb-4">Acc√®s s√©curis√©</h2>
        <div class="d-flex flex-column align-items-center gap-2">
            <input type="password" id="password-input" class="form-control text-center" placeholder="Mot de passe" style="width: 250px;">
            <button onclick="checkPassword()" class="btn btn-success w-100 fw-bold">Entrer</button>
            <p id="login-error" class="text-danger mt-2 fw-bold" style="display: none;">Mot de passe incorrect</p>
        </div>
        <small class="text-white-50 mt-5">Projet Paris</small>
    </div>

    <div id="header">
        <div class="d-flex align-items-center">
            <img src="logo.jpg" alt="Logo" style="height: 50px; width: auto; margin-right: 15px; object-fit: contain;">
            <div>
                <h1 class="h6 m-0 fw-bold text-nowrap">Suivi des actions<br>Paris</h1>
                <small class="text-white-50 d-none d-sm-block" style="font-size: 0.7rem;">¬©Cl√©ment LE GRAND - Tous droits r√©serv√©s.</small>
            </div>
        </div>
        <div class="stats-container">
            <div class="d-flex justify-content-between mb-1" style="font-size: 0.9rem;">
                <span id="stats-text">Connexion...</span>
                <span id="stats-percent" class="fw-bold text-success">--%</span>
            </div>
            <div class="progress">
                <div id="progress-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
            </div>
        </div>
    </div>
    
    <div id="search-container">
        <input type="text" id="search-input" placeholder="üîç Rechercher une rue..." onkeyup="searchStreets()">
        <div id="search-results"></div>
    </div>

    <div id="map"></div>
    <div id="source-display" class="source-info" style="display:none"></div>

    <div class="legend-container" id="legend">
        <div class="legend-header" onclick="toggleLegend()">
            L√©gende <span id="legend-arrow">‚ñº</span>
        </div>
        <div class="legend-content">
            <div class="legend-item"><span class="legend-color" style="background: rgba(0,0,255,0.0); border: 2px solid blue;"></span><span>Arrondissements</span></div>
            <div class="legend-item"><span class="legend-color" style="background: rgba(220, 53, 69, 0.4);"></span><span>Rue √† faire</span></div>
            <div class="legend-item"><span class="legend-color" style="background: #fd7e14;"></span><span>En cours / √Ä repasser</span></div>
            <div class="legend-item"><span class="legend-color" style="background: #28a745;"></span><span>Rue faite</span></div>
            <hr style="margin: 8px 0;">
            <div class="legend-item"><span class="legend-color" style="background: #6f42c1; border: 2px solid white; border-radius: 50%;"></span><span>Note (Appui long)</span></div>
        </div>
    </div>
    
    <div id="loading" class="loading-overlay">
        <div class="spinner-border text-light mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <div id="loading-msg" class="fs-5">D√©marrage...</div>
        <small id="server-status" class="text-warning mt-3" style="font-size: 0.8rem;"></small>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://unpkg.com/osmtogeojson@2.2.12/osmtogeojson.js"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIGURATION
        const MOT_DE_PASSE = "paris2024";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBvYGafOj11LKlAw6M46HMV3x1cURuQcnw",
  			authDomain: "ville-heureuse.firebaseapp.com",
  			databaseURL: "https://ville-heureuse-default-rtdb.firebaseio.com",
  			projectId: "ville-heureuse",
  			storageBucket: "ville-heureuse.firebasestorage.app",
  			messagingSenderId: "264551086726",
  			appId: "1:264551086726:web:078c3075986d2736c1ef07"
        };
        const OVERPASS_SERVERS = [ "https://overpass-api.de/api/interpreter", "https://lz4.overpass-api.de/api/interpreter", "https://overpass.kumi.systems/api/interpreter" ];
        const COLOR_TODO = "#dc3545"; const COLOR_DOING = "#fd7e14"; const COLOR_DONE = "#28a745"; const OPACITY_TODO = 0.4; const OPACITY_DONE = 0.8;

        window.toggleLegend = function() {
            const legend = document.getElementById('legend');
            const arrow = document.getElementById('legend-arrow');
            legend.classList.toggle('collapsed');
            arrow.innerText = legend.classList.contains('collapsed') ? '‚ñ≤' : '‚ñº';
        };

        window.searchStreets = function() {
            const input = document.getElementById('search-input').value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '';
            if (input.length < 3) { resultsDiv.style.display = 'none'; return; }
            const matches = allLayersList.filter(l => l.streetNameNormal && l.streetNameNormal.includes(input)).slice(0, 5);
            if (matches.length > 0) {
                resultsDiv.style.display = 'block';
                matches.forEach(layer => {
                    const div = document.createElement('div');
                    div.className = 'search-result-item'; div.innerText = layer.streetNameDisplay;
                    div.onclick = () => { map.fitBounds(layer.getBounds(), { maxZoom: 17 }); layer.openTooltip(); resultsDiv.style.display = 'none'; };
                    resultsDiv.appendChild(div);
                });
            } else { resultsDiv.style.display = 'none'; }
        };
        document.addEventListener('click', function(e) { if (!document.getElementById('search-container').contains(e.target)) document.getElementById('search-results').style.display = 'none'; });

        window.checkPassword = function() {
            if (document.getElementById('password-input').value === MOT_DE_PASSE) {
                document.getElementById('login-screen').style.display = 'none'; localStorage.setItem('map_auth', 'true'); 
            } else { document.getElementById('login-error').style.display = 'block'; }
        };
        if (localStorage.getItem('map_auth') === 'true') document.getElementById('login-screen').style.display = 'none';

        let db; try { const app = initializeApp(firebaseConfig); db = getDatabase(app); } catch (e) { console.error("Erreur Firebase:", e); }
        
        const planLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, attribution: 'Plan' });
        const satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Satellite' });
        
        // Centrage Paris initial
        const map = L.map('map', { layers: [planLayer], doubleClickZoom: false }).setView([48.8566, 2.3522], 13);

        let streetsGroup = L.layerGroup().addTo(map);
        let notesGroup = L.layerGroup().addTo(map);
        let userMarker = null;

        let allLayersList = []; let communesPolygons = null; let totalStreetsCount = 0; let latestFirebaseData = {}; let latestNotesData = {}; let currentFilter = 'all'; 

        const GeolocControl = L.Control.extend({
            onAdd: function(map) {
                const div = L.DomUtil.create('div', 'leaflet-control-geoloc leaflet-bar leaflet-control');
                div.innerHTML = `<svg class="geoloc-icon" viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>`;
                div.onclick = function(e) { 
                    e.stopPropagation(); e.preventDefault(); 
                    map.locate({ setView: true, maxZoom: 16, timeout: 30000, enableHighAccuracy: false }); 
                }; 
                return div;
            }
        });
        map.addControl(new GeolocControl({ position: 'topleft' }));

        map.on('locationfound', function(e) {
            if (userMarker) { map.removeLayer(userMarker); }
            const gpsIcon = L.divIcon({ className: 'user-location-marker', iconSize: [20, 20], iconAnchor: [10, 10] });
            userMarker = L.marker(e.latlng, {icon: gpsIcon}).addTo(map);
        });

        const FilterControl = L.Control.extend({
            onAdd: function(map) {
                const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control custom-filter');
                div.innerHTML = `<select onmousedown="L.DomEvent.stopPropagation(event)" style="height:30px;"><option value="all">Statut : Tout</option><option value="done">Statut : Fait</option><option value="doing">Statut : En cours</option><option value="todo">Statut : √Ä faire</option></select>`;
                div.querySelector('select').addEventListener('change', function(e) { currentFilter = e.target.value; updateMapDisplay(); }); return div;
            }
        });
        map.addControl(new FilterControl({ position: 'topleft' }));

        const baseMaps = { "Plan": planLayer, "Satellite": satLayer };
        const overlays = { "Rues": streetsGroup, "Notes": notesGroup };
        L.control.layers(baseMaps, overlays, { position: 'topleft', collapsed: false }).addTo(map);

        function handleAddNote(e) {
            const noteText = prompt("Ajouter une note √† cet endroit :");
            if (noteText) {
                push(ref(db, 'notes'), { lat: e.latlng.lat, lng: e.latlng.lng, text: noteText, timestamp: Date.now() });
            }
        }
        map.on('contextmenu', handleAddNote);
        map.on('click', function(e) { if (e.originalEvent.ctrlKey) handleAddNote(e); });

        window.deleteNote = function(noteId) {
            if (confirm("Supprimer cette note ?")) { remove(ref(db, 'notes/' + noteId)); }
        };

        function sanitizeId(id) {
            if (!id) return "inconnu_" + Math.random().toString(36).substr(2, 9);
            return String(id).toLowerCase().replace(/[^a-z0-9]/g, "_");
        }

        async function initMap() {
            try {
                document.getElementById('loading-msg').innerText = "Lecture paris.geojson...";
                
                let geojsonData = null;
                try {
                    const response = await fetch('paris.geojson');
                    if (response.ok) {
                        const textData = await response.text();
                        geojsonData = (textData.trim().startsWith('<')) ? osmtogeojson(new DOMParser().parseFromString(textData, "text/xml")) : JSON.parse(textData);
                    } else { throw new Error("Non trouv√©"); }
                } catch (fetchError) {
                    document.getElementById('loading-msg').innerHTML = `
                        <div class="mb-3 text-warning">Impossible de charger paris.geojson automatiquement.</div>
                        <label class="btn btn-primary fw-bold shadow">üìÇ Ouvrir "paris.geojson" <input type="file" id="manual-file-input" accept=".geojson,.json,.xml" style="display: none;"></label>
                    `;
                    geojsonData = await new Promise((resolve, reject) => {
                        const input = document.getElementById('manual-file-input');
                        input.onchange = e => {
                            const file = e.target.files[0];
                            if (!file) return;
                            const reader = new FileReader();
                            reader.onload = event => {
                                const text = event.target.result;
                                resolve((text.trim().startsWith('<')) ? osmtogeojson(new DOMParser().parseFromString(text, "text/xml")) : JSON.parse(text));
                            };
                            reader.readAsText(file);
                        };
                    });
                }

                // Affichage Fronti√®res (Bleu)
                document.getElementById('loading-msg').innerText = "Construction de la carte...";
                communesPolygons = geojsonData;
                const boundaryLayer = L.geoJSON(communesPolygons, { 
                    style: function(feature) { return { color: "blue", weight: 2, fillColor: "blue", fillOpacity: 0.05, interactive: false }; },
                    filter: function(feature) { return feature.geometry.type !== "Point"; }
                }).addTo(map);
                map.fitBounds(boundaryLayer.getBounds());

                document.getElementById('loading-msg').innerText = "T√©l√©chargement des rues OSM...";
                
                // --- REQU√äTE OPTIMIS√âE POUR PARIS ---
                // 1. Timeout augment√© √† 90s
                // 2. Filtre strict sur les types de routes (exclut trottoirs, pistes cyclables isol√©es, etc.)
                let query = `[out:json][timeout:90];(`;
                const bounds = boundaryLayer.getBounds();
                const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
                
                // On demande uniquement les routes nomm√©es (Residential, Primary, etc.)
                query += `way["highway"~"^(residential|primary|secondary|tertiary|unclassified|living_street)$"]["name"](${bbox});`;
                query += `);out geom;`;

                const overpassUrl = OVERPASS_SERVERS[Math.floor(Math.random() * OVERPASS_SERVERS.length)] + "?data=" + encodeURIComponent(query);
                
                try {
                    const osmResponse = await fetch(overpassUrl);
                    if (!osmResponse.ok) throw new Error("Overpass satur√© (" + osmResponse.status + ")");
                    const osmData = await osmResponse.json();
                    const streetFeatures = osmtogeojson(osmData);
                    
                    L.geoJSON(streetFeatures, {
                        style: { color: COLOR_TODO, weight: 4, opacity: OPACITY_TODO },
                        onEachFeature: function(feature, layer) {
                            const streetName = feature.properties.name;
                            if (streetName) {
                                const safeId = sanitizeId(streetName);
                                layer.streetId = safeId;
                                layer.streetNameDisplay = streetName;
                                layer.streetNameNormal = streetName.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                                layer.bindTooltip(`<div class="street-tooltip">${streetName}</div>`, { permanent: false, sticky: true, direction: 'center' });
                                layer.on('click', () => {
                                    const currentStatus = layer.status || 'todo';
                                    let nextStatus = 'doing';
                                    if (currentStatus === 'doing') nextStatus = 'done';
                                    else if (currentStatus === 'done') nextStatus = 'todo';
                                    set(ref(db, 'streets/' + safeId), { status: nextStatus, timestamp: Date.now() });
                                });
                                streetsGroup.addLayer(layer);
                                allLayersList.push(layer);
                                totalStreetsCount++;
                            }
                        }
                    });
                } catch (errOSM) {
                    console.error(errOSM);
                    document.getElementById('server-status').innerText = "Erreur chargement rues : Zone trop grande ou serveur occup√©.";
                }

                onValue(ref(db, 'streets'), (snapshot) => {
                    latestFirebaseData = snapshot.val() || {};
                    updateMapDisplay();
                });
                onValue(ref(db, 'notes'), (snapshot) => {
                    latestNotesData = snapshot.val() || {};
                    updateNotesDisplay();
                });

                document.getElementById('loading').classList.add('hidden');

            } catch (error) {
                console.error(error);
                document.getElementById('loading-msg').innerHTML = `<span class="text-danger">Erreur: ${error.message}</span>`;
            }
        }

        function updateMapDisplay() {
            let doneCount = 0;
            allLayersList.forEach(layer => {
                const status = (latestFirebaseData[layer.streetId] && latestFirebaseData[layer.streetId].status) ? latestFirebaseData[layer.streetId].status : 'todo';
                layer.status = status;
                
                if (status === 'done') { layer.setStyle({ color: COLOR_DONE, opacity: OPACITY_DONE }); doneCount++; } 
                else if (status === 'doing') { layer.setStyle({ color: COLOR_DOING, opacity: 0.9 }); } 
                else { layer.setStyle({ color: COLOR_TODO, opacity: OPACITY_TODO }); }

                if (currentFilter === 'all' || status === currentFilter) { if (!map.hasLayer(layer)) streetsGroup.addLayer(layer); } 
                else { if (map.hasLayer(layer)) streetsGroup.removeLayer(layer); }
            });
            const percent = (totalStreetsCount > 0) ? Math.round((doneCount / totalStreetsCount) * 100) : 0;
            document.getElementById('stats-text').innerText = `${doneCount} / ${totalStreetsCount} rues`;
            document.getElementById('stats-percent').innerText = `${percent}%`;
            document.getElementById('progress-bar').style.width = `${percent}%`;
        }

        function updateNotesDisplay() {
            notesGroup.clearLayers();
            Object.keys(latestNotesData).forEach(key => {
                const note = latestNotesData[key];
                const noteMarker = L.circleMarker([note.lat, note.lng], { radius: 8, color: "white", fillColor: "#6f42c1", fillOpacity: 1, weight: 2 });
                const dateStr = new Date(note.timestamp).toLocaleDateString();
                const popupContent = `<div style="min-width:150px"><strong>Note du ${dateStr}</strong><br><p class="mt-2 mb-2">${note.text}</p><button class="btn-delete-note" onclick="deleteNote('${key}')">Supprimer</button></div>`;
                noteMarker.bindPopup(popupContent, { className: 'note-popup' });
                notesGroup.addLayer(noteMarker);
            });
        }

        initMap();

    </script>
</body>
</html>
